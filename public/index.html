<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Statement Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .content { padding: 30px; }
        .upload-section { text-align: center; padding: 40px; border: 3px dashed #ddd; border-radius: 15px; margin-bottom: 30px; transition: all 0.3s ease; background: #fafafa; }
        .upload-section.dragover { border-color: #3498db; background: #e3f2fd; }
        .upload-icon { font-size: 4rem; color: #3498db; margin-bottom: 20px; }
        .upload-button { background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .upload-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
        .upload-button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        .file-input { display: none; }
        .processing { display: none; margin-top: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .summary-dashboard { display: none; margin-bottom: 30px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border-left: 5px solid; transition: transform 0.3s ease; }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card.balance { border-left-color: #3498db; }
        .summary-card.deposits { border-left-color: #27ae60; }
        .summary-card.withdrawals { border-left-color: #e74c3c; }
        .summary-card.account { border-left-color: #9b59b6; }
        .summary-card h3 { color: #2c3e50; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .summary-card .value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .summary-card.deposits .value { color: #27ae60; }
        .summary-card.withdrawals .value { color: #e74c3c; }
        .transaction-section { display: none; }
        .table-container { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .table-header { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #eee; }
        .table-header h2 { color: #2c3e50; margin-bottom: 10px; }
        .table-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .control-button { background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 25px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; }
        .control-button:hover { background: #2980b9; transform: translateY(-1px); }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 15px 20px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #2c3e50; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr { transition: background-color 0.2s ease; }
        tr:hover { background: #f8f9fa; }
        tr.unchecked { opacity: 0.5; background: #f9f9f9; }
        .transaction-checkbox { width: 18px; height: 18px; accent-color: #3498db; }
        .amount-positive { color: #27ae60; font-weight: bold; }
        .amount-negative { color: #e74c3c; font-weight: bold; }
        .recurring-indicator { display: inline-block; width: 12px; height: 12px; background: #f39c12; border-radius: 50%; margin-left: 8px; position: relative; }
        .recurring-indicator::after { content: "R"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 8px; font-weight: bold; }
        .description-cell { max-width: 300px; overflow: hidden; text-overflow: ellipsis; }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .content { padding: 15px; } .summary-grid { grid-template-columns: 1fr; } table { font-size: 0.9rem; } th, td { padding: 10px 15px; } .description-cell { max-width: 150px; } }
        .error-message { background: #ffe6e6; border: 1px solid #ffcccc; color: #d32f2f; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Bank Statement Analyzer</h1><p>Upload your bank statement PDF and get instant transaction analysis</p></div>
        <div class="content">
            <div class="upload-section" id="uploadSection"><div class="upload-icon">ðŸ“„</div><h2>Upload Bank Statement</h2><p>Drag and drop your PDF file here or click to browse</p><br><button class="upload-button" id="uploadButton">Choose PDF File</button><input type="file" id="fileInput" class="file-input" accept=".pdf"><div class="processing" id="processing"><div class="spinner"></div><p>Processing your bank statement...</p></div></div>
            <div class="error-message" id="errorMessage"></div>
            <div class="summary-dashboard" id="summaryDashboard"><h2>Account Summary</h2><div class="summary-grid"><div class="summary-card balance"><h3>Net Change</h3><div class="value" id="currentBalance">$0.00</div></div><div class="summary-card deposits"><h3>Total Deposits</h3><div class="value" id="totalDeposits">$0.00</div></div><div class="summary-card withdrawals"><h3>Total Withdrawals</h3><div class="value" id="totalWithdrawals">$0.00</div></div><div class="summary-card account"><h3>Account Info</h3><div class="value" id="accountInfo" style="font-size: 1.2rem;">Loading...</div></div></div></div>
            <div class="transaction-section" id="transactionSection"><div class="table-container"><div class="table-header"><h2>Transaction History</h2><div class="table-controls"><button class="control-button" id="selectAllBtn">Select All</button><button class="control-button" id="deselectAllBtn">Deselect All</button><button class="control-button" id="exportBtn">Export CSV</button></div></div><table id="transactionTable"><thead><tr><th>Select</th><th>Date</th><th>Description</th><th>Amount</th></tr></thead><tbody id="transactionTableBody"></tbody></table></div></div>
        </div>
    </div>
    
    <script>
        // --- UPDATED APPLICATION STATE ---
        let transactions = [];
        let accountInfo = {};
        let accountSummary = {}; // New state for the PDF's summary section

        // DOM Elements
        const uploadSection = document.getElementById('uploadSection');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const processing = document.getElementById('processing');
        const summaryDashboard = document.getElementById('summaryDashboard');
        const transactionSection = document.getElementById('transactionSection');
        const errorMessage = document.getElementById('errorMessage');

        class UploadComponent {
            constructor() { this.initializeEventListeners(); }
            initializeEventListeners() {
                uploadButton.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                uploadSection.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadSection.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadSection.addEventListener('drop', this.handleDrop.bind(this));
            }
            handleDragOver(e) { e.preventDefault(); uploadSection.classList.add('dragover'); }
            handleDragLeave(e) { e.preventDefault(); uploadSection.classList.remove('dragover'); }
            handleDrop(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') { this.processFile(files[0]); }
            }
            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') { this.processFile(file); }
            }
            async processFile(file) {
                console.log("ðŸš€ [DEBUG] 1. Starting processFile...");
                this.showProcessing();
                try {
                    const processedData = await AIProcessor.processPDF(file);
                    console.log("ðŸš€ [DEBUG] 4. Received processed data from AIProcessor:", processedData);

                    // --- UPDATED: Set global state variables ---
                    transactions = processedData.transactions.map(t => ({...t, selected: true }));
                    accountInfo = processedData.statement_info;
                    accountSummary = processedData.account_summary; // Store the new summary object
                    console.log("ðŸš€ [DEBUG] 5. Global state updated.", {transactions, accountInfo, accountSummary});
                    
                    this.hideProcessing();
                    summaryDashboard.style.display = 'block';
                    transactionSection.style.display = 'block';
                    
                    TransactionIdentifier.identifyRecurring();
                    SummaryDashboard.update(); // This will now use the new accountSummary
                    TransactionTable.render();
                } catch (error) {
                    console.error("âŒ [ERROR] in processFile:", error);
                    this.hideProcessing();
                    this.showError('Failed to process PDF: ' + error.message);
                }
            }
            showProcessing() { uploadButton.disabled = true; processing.style.display = 'block'; }
            hideProcessing() { uploadButton.disabled = false; processing.style.display = 'none'; }
            showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
            }
        }

        class AIProcessor {
            static async processPDF(file) {
                const formData = new FormData();
                formData.append('bankStatement', file);

                const response = await fetch('/process-pdf', { method: 'POST', body: formData });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error');
                }

                const data = await response.json();
                console.log("ðŸš€ [DEBUG] 2. Received raw JSON from server:", data);
                
                const schemaData = data.schema || {};
                console.log("ðŸš€ [DEBUG] 3. Extracted schema data:", schemaData);

                const transactionsArray = Array.isArray(schemaData.transactions) ? schemaData.transactions : [];

                transactionsArray.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (isNaN(dateA)) return 1;
                    if (isNaN(dateB)) return -1;
                    return dateB - dateA;
                });
                
                // --- UPDATED: Return the account_summary object as well ---
                return {
                    statement_info: schemaData.statement_info || {},
                    account_summary: schemaData.account_summary || {}, // Pass the summary through
                    transactions: transactionsArray
                };
            }
        }

        class TransactionIdentifier {
            static identifyRecurring() { /* No changes needed here */ }
            static extractVendor(description) { /* No changes needed here */ }
        }

        class SummaryDashboard {
            // --- COMPLETELY REWRITTEN to use the PDF's official summary ---
            static update() {
                console.log("ðŸš€ [DEBUG] 7. Updating summary dashboard using official account summary:", accountSummary);

                // Use values directly from the PDF's summary section, with fallbacks to 0
                const totalDeposits = parseFloat(accountSummary.total_deposits) || 0;
                // Withdrawals from Gemini are negative, so we use addition for net change
                const totalWithdrawalsValue = parseFloat(accountSummary.total_withdrawals) || 0; 
                
                const netChange = totalDeposits + totalWithdrawalsValue;

                document.getElementById('totalDeposits').textContent = `+$${totalDeposits.toFixed(2)}`;
                document.getElementById('totalWithdrawals').textContent = `-$${Math.abs(totalWithdrawalsValue).toFixed(2)}`;
                document.getElementById('currentBalance').textContent = `$${netChange.toFixed(2)}`;
                document.getElementById('accountInfo').innerHTML = `<div style="font-size: 0.8rem; line-height: 1.4;">${accountInfo.account_number || 'N/A'}<br>${accountInfo.account_holder_name || 'N/A'}</div>`;
            }
        }

        class TransactionTable {
            static render() {
                console.log("ðŸš€ [DEBUG] 8. Rendering transaction table with", transactions.length, "transactions.");
                const tbody = document.getElementById('transactionTableBody');
                tbody.innerHTML = '';
                if (transactions.length === 0) {
                    console.warn("âš ï¸ [WARN] No transactions to render in the table.");
                }
                transactions.forEach((transaction, index) => {
                    const row = document.createElement('tr');
                    if (!transaction.selected) row.classList.add('unchecked');
                    
                    const amount = parseFloat(transaction.amount) || 0;
                    const amountClass = amount >= 0 ? 'amount-positive' : 'amount-negative';
                    const amountPrefix = amount >= 0 ? '+' : '-';
                    const amountValue = Math.abs(amount);
                    
                    let date = 'Invalid Date';
                    if (transaction.date) {
                        const dateParts = transaction.date.split('/');
                        if (dateParts.length === 2) {
                            date = new Date(`${dateParts[0]}/${dateParts[1]}/${new Date().getFullYear()}`).toLocaleDateString();
                        } else {
                            date = new Date(transaction.date).toLocaleDateString();
                        }
                    }

                    row.innerHTML = `
                        <td><input type="checkbox" class="transaction-checkbox" ${transaction.selected ? 'checked' : ''} data-index="${index}"></td>
                        <td>${date}</td>
                        <td class="description-cell">${transaction.description || ''}${transaction.isRecurring ? '<span class="recurring-indicator"></span>' : ''}</td>
                        <td class="${amountClass}">${amountPrefix}$${amountValue.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
                this.attachEventListeners();
            }
            static attachEventListeners() {
                document.querySelectorAll('.transaction-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        transactions[index].selected = e.target.checked;
                        e.target.closest('tr').classList.toggle('unchecked', !e.target.checked);
                        // NOTE: We no longer update the dashboard on checkbox change, as it shows official totals.
                        // If you want to show a "Selected Total", you would need a new element in the UI.
                    });
                });
                document.getElementById('selectAllBtn').addEventListener('click', () => { transactions.forEach(t => t.selected = true); this.render(); });
                document.getElementById('deselectAllBtn').addEventListener('click', () => { transactions.forEach(t => t.selected = false); this.render(); });
                document.getElementById('exportBtn').addEventListener('click', this.exportToCSV);
            }
            static exportToCSV() { /* No changes needed here */ }
        }

        // Re-add the classes that were removed in the previous snippet for completeness
        Object.assign(TransactionIdentifier, {
            identifyRecurring() {
                console.log("ðŸš€ [DEBUG] 6. Identifying recurring transactions...");
                const vendors = {};
                transactions.forEach((transaction, index) => {
                    if (transaction.amount < 0 && transaction.description) {
                        const vendor = this.extractVendor(transaction.description);
                        if (vendor) {
                            if (!vendors[vendor]) vendors[vendor] = [];
                            vendors[vendor].push(index);
                        }
                    }
                });
                Object.values(vendors).forEach(indices => {
                    if (indices.length >= 2) {
                        indices.forEach(index => { transactions[index].isRecurring = true; });
                    }
                });
            },
            extractVendor(description) {
                const words = description.toLowerCase().split(' ');
                return words.find(word => word.length > 3 && !['payment', 'purchase', 'bill', 'subscription', 'withdrawal', 'deposit'].includes(word));
            }
        });

        Object.assign(TransactionTable, {
            exportToCSV() {
                const selectedTransactions = transactions.filter(t => t.selected);
                const csvContent = [['Date', 'Description', 'Amount', 'Recurring'], ...selectedTransactions.map(t => [t.date, `"${(t.description || '').replace(/"/g, '""')}"`, t.amount, t.isRecurring ? 'Yes' : 'No'])].map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bank_transactions.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
        });

        new UploadComponent();
    </script>
</body>
</html>